---
layout: article
category: Research
date: 2023-06-06
title: 如何使用wget下载(录制)流媒体或直播推流文件，以及下载出现“正在把输出重定向至 “wget-log.1””错误该怎么办
---
<!-- excerpt-start -->
下载推流文件其实非常简单，就是通常使用的最简单的命令：

```
wget URL -O 输出文件名
```

这里最好设置一下输出文件名，不然很可能下载的文件名称会很奇怪，导致格式识别错误或者其他问题。

不过，如果你直接使用这个命令很可能会出现一种情况：

```
$ wget https://xxx.xxx.com/.... -O 1.flv
[2] 60387
[3] 60388
[4] 60389
-bash: 1.flv: command not found
[3]-  Done                    sign=xxxxxxxxxxxxxxxxxxx
[4]+  Done                    abr_pts=-1800
$ 
正在把输出重定向至 “wget-log.1”。
```

这是因为很多推流地址都会有各种参数（query）来表示一些其他信息，比如识别访问的人，如果你删除一些参数，那么会导致链接没有作用。而 URL 参数的分隔符是`&`，但是符号`&`在`bash`等很多 Shell 中表示顺序执行命令的分隔符，所以这导致 Shell 在我们不想的地方分隔了输入命令。

这时候我们可以在`&`前面加上反斜杠`\`来让 Shell 将其当作简单的字符`&`，而不是命令分隔符。但是这样处理之后，其他的一些符号也可能会导致一些问题，所以最简单、高效的办法就是给其加上`"`，将其变成字符串。 
因为 Shell 处理字符串是遇到一个`"`开始，直到遇到第二个`"`在结束识别字符串，这其中的任何符号都会被当成简单的字符来识别。这时输入的命令如下：

```
$ wget "https://xxx.xxx.com/...." -O 1.flv
--2023-06-02 03:57:01--  https://xxx.xxx.com/....
正在解析主机 [隐去的细节]
正在连接 [隐去的细节]|IP|:xxx... 已连接。
已发出 HTTP 请求，正在等待回应... 200 OK
长度：未指定 [video/格式]
正在保存至: “1.flv”

1.flv                   [    <=>             ]   1.80M   159KB/s               
```

可以看到正常的下载了，下载速度也就是码率，如果下载中断也会保留已下载的部分。

不过下载录制之后，如果遇到无法拖动进度条或者不一定每次播放都成功的这些问题，建议用`ffmpeg`等转码工具转一次码，转换时设置的码率稍微比稳定之后的下载速度的 12 倍大一些即可。

**2023-06-06 更新：发现可以使用`-c:v copy`来获取和应用源视频的设置，包括码率。所以命令可以写作：**

```
$ ffmpeg -hwaccel videotoolbox -i in.flv -c:v h264_videotoolbox -c:v copy out.mp4
```

这种使用源设置的方法可以让转码速度提升十倍左右，所以最好使用这种：

<img alt="使用源设置的方法可以让转码速度提升十倍左右" src="/assets/images/7bc27a0c3abb47d288ccaee637ab12cf.png" style="box-shadow: 0px 0px 0px 0px">

转码还有个好处，有些直播推流是下播之后很久才结束，但是视频信息是算了这段时间，但是没有数据。如果你把进度条拖到这个地方，那么视频播放会自动结束。如果转码的话就可以纠正这个问题。

设置码率稍大一些有两个方面的原因：
1. 因为如果格式发生转换，可能会有损耗；
2. 因为一个视频的码率并不是恒定的，而是在一个范围内波动的。如果你只看了某一瞬间的速度，而这个这个速率与平均码率相差甚远，最高码率可能会超出`ffmpeg`允许的偏差，可能会小了。

这里可能会有人有疑问说：为什么是 12 倍？不应该是 8 倍吗？因为`1 Byte = 8 bit`。

这里之所以是 12 倍是因为下载速度是`这个时段下载的文件大小/这个时段间隔`，然后以`KB/s`为单位。但是`wget`实际刷新速度的间隔并不是 1 秒，加之下载文件并不是一堆流一直下，而是一段一段，这就导致`wget`显示的下载速度波动很大，有的时候前后显示差距能有一倍。12 倍是用`1.5x8=12`，是一个比较折中的值，如果你不放心可以还大一些。

所以最好还是下载完手算一下，但是有的视频都打不开，也看不到视频信息，那就得按照下载速度推理了。

如果你和我一样觉得：之前不是说视频实际时长可能要比视频信息里的时长要短嘛，那是不是就能抵消掉这个波动呢？

这个我试过，如果将手算 3000K 码率的视频设置为 2000K 码率，那么画质会有比较大的损失（肉眼可见的）。下面是一个对比（左侧为 3000K，右侧为 2000K）：

![左侧为 2000K，右侧为 3000K](/assets/images/76d8a89cc2a540e6b0d532fe1c4f88e5.png)

可以看到 2000K 的头发丝涂抹感严重多了（虽然本来就不是很清晰，因为户外主播码率本来就比较低，但是这样就更模糊了）。更精细的`ffmpeg`码率对比可以看我的另外一篇文章[《macOS上如何安装（不需要编译安装或者brew）、使用ffmpeg转码的教程，以及如何使用硬件加速》](https://blog.csdn.net/qq_33919450/article/details/122053917)最后的测试对比部分。

有人在手算码率的时候可能会有人担心一点：不少软件是很认真的按照计算机科学中的`1KB = 1000 Byte`，`1 KiB = 1024 Byte`，因为绝大部分类 Unix 系统都是 1000 进制的，很多人还是在工业环境里干过的。但是有一部分程序员分不清，或者是因为主要开发 Windows上 的程序，就按照 Windows 上的`1KB = 1024 Byte`设置的。那么到底按哪个进行计算呢？

我确定过了，`wget`和`ffmpeg`都是按照计算机科学中的`1KB = 1000 Byte`，`1 KiB = 1024 Byte`设置的。而且在`K`这个级别，二者差别比较小，基本可以忽略。所以如果你使用的是`ffmpeg`等比较著名的命令行转码软件，那么不用担心这个问题，按照`1KB = 1000 Byte`这种进制进行计算。

但是如果你使用的是 Windows 上的软件，那么很大概率是按照`1KB = 1024 Byte`的进制进行计算的。不过有些软件是用的`KiB`或者`MiB`这种单位的软件，那么就按照`1 KiB = 1024 Byte`进行计算就行（比如“B站录播姬”）。

希望能帮到有需要的人～