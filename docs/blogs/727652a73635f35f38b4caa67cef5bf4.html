<!doctype html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv='content-language' content='zh-CN'>
        <title>「SwiftUI」获取网站api中的JSON，并且显示其中的文本</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" type="text/css" href="/assets/css/headerstyle.css" />
        <link rel="stylesheet" type="text/css" href="/assets/css/blogstyle.css" />
        <link rel="stylesheet" type="text/css" href="/assets/css/style.css" />
        <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>「SwiftUI」获取网站api中的JSON，并且显示其中的文本</title>
<meta name="generator" content="Jekyll v4.3.1" />
<meta property="og:title" content="「SwiftUI」获取网站api中的JSON，并且显示其中的文本" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="这是开发中非常常见的使用场景。" />
<meta property="og:description" content="这是开发中非常常见的使用场景。" />
<link rel="canonical" href="https://zhonguncle.github.io/blogs/727652a73635f35f38b4caa67cef5bf4.html" />
<meta property="og:url" content="https://zhonguncle.github.io/blogs/727652a73635f35f38b4caa67cef5bf4.html" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2022-02-11T00:00:00+08:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="「SwiftUI」获取网站api中的JSON，并且显示其中的文本" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-02-11T00:00:00+08:00","datePublished":"2022-02-11T00:00:00+08:00","description":"这是开发中非常常见的使用场景。","headline":"「SwiftUI」获取网站api中的JSON，并且显示其中的文本","mainEntityOfPage":{"@type":"WebPage","@id":"https://zhonguncle.github.io/blogs/727652a73635f35f38b4caa67cef5bf4.html"},"url":"https://zhonguncle.github.io/blogs/727652a73635f35f38b4caa67cef5bf4.html"}</script>
<!-- End Jekyll SEO tag -->

    </head>
    <body>
        <div class="stackedit__html">
            <!-- 这个文件里是用来生成导航栏的 -->
<div class="header">
    
        <a href="/index.html" class="headerItem">
            主页
        </a>
    
        <a href="/swift.html" class="headerItem">
            Swift
        </a>
    
        <a href="/unix.html" class="headerItem">
            UNIX
        </a>
    
        <a href="/c.html" class="headerItem">
            C
        </a>
    
        <a href="/assembly.html" class="headerItem">
            Assembly
        </a>
    
        <a href="/go.html" class="headerItem">
            Go
        </a>
    
        <a href="/plan9.html" class="headerItem">
            Plan 9
        </a>
    
        <a href="/web.html" class="headerItem">
            Web
        </a>
    
        <a href="/research.html" class="headerItem">
            Research
        </a>
    
        <a href="/non-tech.html" class="headerItem">
            Non-Tech
        </a>
    
</div>
            <h1>「SwiftUI」获取网站api中的JSON，并且显示其中的文本</h1>
            <div class="bloginfo">
                <p class="info">2022-02-11 ｜ <a href="/swift.html"> Swift</a> ｜ 1812 字</p>
            </div>
            <!-- excerpt-start -->
<p>这是开发中非常常见的使用场景。</p>

<p>首先，我们需要知道要获取的json是什么样的，有两种方式得知：</p>

<p><strong>第一，查询API文档</strong>：
一般在网站API文档中会介绍，如下：</p>

<p><img src="/assets/images/56bf8c159e5a4f1d9b19b96f4f51f0d1.png" alt="网站API文档中会介绍JSON格式" /></p>

<p><strong>第二种，通过使用<code class="language-plaintext highlighter-rouge">crul -H</code>获取</strong>：
这种方法需要使用到<strong>终端</strong>，上图也介绍了这个方式，如下：</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">$</span> <span class="n">curl</span> <span class="o">-</span><span class="kt">H</span> <span class="s">"Accept: application/json"</span> <span class="nv">https</span><span class="p">:</span><span class="c1">//icanhazdadjoke.com/</span>
<span class="p">{</span>
  <span class="s">"id"</span><span class="p">:</span> <span class="s">"R7UfaahVfFd"</span><span class="p">,</span>
  <span class="s">"joke"</span><span class="p">:</span> <span class="s">"My dog used to chase people on a bike a lot. It got so bad I had to take his bike away."</span><span class="p">,</span>
  <span class="s">"status"</span><span class="p">:</span> <span class="mi">200</span>
<span class="p">}</span>
</code></pre></div></div>

<p>在我们知晓获取的JSON的格式之后，我们开始敲代码，首先头文件需要添加<code class="language-plaintext highlighter-rouge">import Combine</code>，完整头文件如下：</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">import</span> <span class="kt">SwiftUI</span>
<span class="kd">import</span> <span class="kt">Combine</span>
</code></pre></div></div>

<p>然后，我们需要新建一个结构体来解读存放JSON格式的内容。以上面获取的为例，此JSON每条数据有三个元素组成：</p>

<ol>
  <li><code class="language-plaintext highlighter-rouge">id</code>：需要注意这里的<code class="language-plaintext highlighter-rouge">id</code>是字符串类型。但是有的<code class="language-plaintext highlighter-rouge">id</code>是UUID类型。</li>
  <li>joke：很显然这是字符串类型。</li>
  <li>status：整数类型。</li>
</ol>

<p>然后我们写如下结构体（<strong>需要注意类型千万不能写错，不然会解码错误</strong>）：</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//如果获取的JSON文件中含有多条，我们也打算存放到一个数组中，这里需要加上Identifiable</span>
<span class="kd">struct</span> <span class="kt">Joke</span><span class="p">:</span> <span class="kt">Codable</span> <span class="p">{</span>
    <span class="k">var</span> <span class="nv">id</span><span class="p">:</span> <span class="kt">String</span>
    <span class="k">var</span> <span class="nv">joke</span><span class="p">:</span> <span class="kt">String</span>
    <span class="k">var</span> <span class="nv">status</span><span class="p">:</span> <span class="kt">Int</span>
<span class="p">}</span>
</code></pre></div></div>

<p>然后我们用刚写好的<code class="language-plaintext highlighter-rouge">Joke类型</code>创建一个变量来获取和存储解码后的数据，内容全是空或0（你也可以根据需要添加合适的占位词）。并且出于方便，我直接写到视图的结构体中。
<strong>需要注意的是，演示中每次只获取了一条数据，我们可以使用单独的一个变量存放，每次刷新。但是平时我们更常使用数组来存放，如果这里使用数组存放的话，赋值的时候记得使用<code class="language-plaintext highlighter-rouge">append</code>而不是<code class="language-plaintext highlighter-rouge">=</code>。如果获取的JSON本身就包含好多条数据，那么还是用<code class="language-plaintext highlighter-rouge">=</code>。</strong></p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">@State</span> <span class="kd">private</span> <span class="k">var</span> <span class="nv">jokes</span><span class="p">:</span> <span class="kt">Joke</span> <span class="o">=</span> <span class="kt">Joke</span><span class="p">(</span><span class="nv">id</span><span class="p">:</span> <span class="s">""</span><span class="p">,</span> <span class="nv">joke</span><span class="p">:</span> <span class="s">""</span><span class="p">,</span> <span class="nv">status</span><span class="p">:</span> <span class="mi">0</span><span class="p">)</span>
</code></pre></div></div>

<p>然后就是写一个函数来获取、解码和存储JSON数据了（由于需要使用上面我们新建的变量，所以要把这个函数和变量放在同一个<code class="language-plaintext highlighter-rouge">struct</code>或者<code class="language-plaintext highlighter-rouge">class</code>中），如下：</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">func</span> <span class="nf">getJoke</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">//设置需要获取的网址</span>
        <span class="k">let</span> <span class="nv">url</span> <span class="o">=</span> <span class="kt">URL</span><span class="p">(</span><span class="nv">string</span><span class="p">:</span> <span class="s">"https://icanhazdadjoke.com/"</span><span class="p">)</span><span class="o">!</span>
        <span class="c1">//请求网址</span>
        <span class="k">var</span> <span class="nv">urlRequest</span> <span class="o">=</span> <span class="kt">URLRequest</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span><span class="n">url</span><span class="p">)</span>
        <span class="c1">//请求获取的类型是application/json（也就是JSON类型）</span>
        <span class="n">urlRequest</span><span class="o">.</span><span class="nf">addValue</span><span class="p">(</span><span class="s">"application/json"</span><span class="p">,</span><span class="nv">forHTTPHeaderField</span><span class="p">:</span> <span class="s">"Accept"</span><span class="p">)</span>
        <span class="c1">//检查获取到的数据</span>
        <span class="kt">URLSession</span><span class="o">.</span><span class="n">shared</span><span class="o">.</span><span class="nf">dataTask</span><span class="p">(</span><span class="nv">with</span><span class="p">:</span> <span class="n">urlRequest</span><span class="p">)</span> <span class="p">{</span> <span class="n">data</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">error</span> <span class="k">in</span>
            <span class="k">do</span> <span class="p">{</span>
                <span class="c1">//将数据赋值给jokeDate，并且判断数据不为空的话</span>
                <span class="k">if</span> <span class="k">let</span> <span class="nv">jokeData</span> <span class="o">=</span> <span class="n">data</span> <span class="p">{</span>
                    <span class="c1">//设置解码器为JSONDecoder()</span>
                    <span class="k">let</span> <span class="nv">decoder</span> <span class="o">=</span> <span class="kt">JSONDecoder</span><span class="p">()</span>
                    <span class="c1">//按照我们之前创建的Joke结构体的数据结构解码获取到的数据（如果我们打算放到数组中，给这里的Joke加个中括号）</span>
                    <span class="k">let</span> <span class="nv">decodedData</span> <span class="o">=</span> <span class="k">try</span> <span class="n">decoder</span><span class="o">.</span><span class="nf">decode</span><span class="p">(</span><span class="kt">Joke</span><span class="o">.</span><span class="k">self</span><span class="p">,</span> <span class="nv">from</span><span class="p">:</span> <span class="n">jokeData</span><span class="p">)</span>
                    <span class="c1">//为了防止数据过多，加载时间过长，这里使用异步加载</span>
                    <span class="kt">DispatchQueue</span><span class="o">.</span><span class="n">main</span><span class="o">.</span><span class="k">async</span> <span class="p">{</span>
                        <span class="c1">//将解码后的数据赋值给之前准备好的空变量</span>
                        <span class="k">self</span><span class="o">.</span><span class="n">jokes</span> <span class="o">=</span> <span class="n">decodedData</span>
                    <span class="p">}</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="c1">//如果数据是空的，在控制台输出下面的文本</span>
                    <span class="nf">print</span><span class="p">(</span><span class="s">"No data"</span><span class="p">)</span>
                <span class="p">}</span>
            <span class="p">}</span> <span class="k">catch</span> <span class="p">{</span>
                <span class="nf">print</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="p">}</span><span class="o">.</span><span class="nf">resume</span><span class="p">()</span>
    <span class="p">}</span>

</code></pre></div></div>

<p>下面列出完整代码：</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">import</span> <span class="kt">SwiftUI</span>
<span class="kd">import</span> <span class="kt">Combine</span>

<span class="kd">struct</span> <span class="kt">Joke</span><span class="p">:</span> <span class="kt">Codable</span> <span class="p">{</span>
    <span class="k">var</span> <span class="nv">id</span><span class="p">:</span> <span class="kt">String</span>
    <span class="k">var</span> <span class="nv">joke</span><span class="p">:</span> <span class="kt">String</span>
    <span class="k">var</span> <span class="nv">status</span><span class="p">:</span> <span class="kt">Int</span>
<span class="p">}</span>

<span class="kd">struct</span> <span class="kt">ContentView</span><span class="p">:</span> <span class="kt">View</span> <span class="p">{</span>
    <span class="c1">//来获取和存储解码后的数据的Joke数据类型的变量</span>
    <span class="kd">@State</span> <span class="kd">private</span> <span class="k">var</span> <span class="nv">jokes</span><span class="p">:</span> <span class="kt">Joke</span> <span class="o">=</span> <span class="kt">Joke</span><span class="p">(</span><span class="nv">id</span><span class="p">:</span> <span class="s">""</span><span class="p">,</span> <span class="nv">joke</span><span class="p">:</span> <span class="s">""</span><span class="p">,</span> <span class="nv">status</span><span class="p">:</span> <span class="mi">0</span><span class="p">)</span>

    <span class="k">var</span> <span class="nv">body</span><span class="p">:</span> <span class="kd">some</span> <span class="kt">View</span> <span class="p">{</span>
        <span class="kt">VStack</span> <span class="p">{</span>
            <span class="kt">Button</span><span class="p">(</span><span class="s">"获取"</span><span class="p">)</span> <span class="p">{</span>
                <span class="nf">getJoke</span><span class="p">()</span>
            <span class="p">}</span>
            <span class="kt">VStack</span><span class="p">(</span><span class="nv">alignment</span><span class="p">:</span> <span class="o">.</span><span class="n">leading</span><span class="p">)</span> <span class="p">{</span>
                <span class="kt">Text</span><span class="p">(</span><span class="n">jokes</span><span class="o">.</span><span class="n">joke</span><span class="p">)</span>
            <span class="p">}</span>
            <span class="o">.</span><span class="nf">onAppear</span><span class="p">(</span><span class="nv">perform</span><span class="p">:</span> <span class="p">{</span>
                <span class="c1">//界面出现的时候加载数据</span>
                <span class="nf">getJoke</span><span class="p">()</span>
            <span class="p">})</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="kd">func</span> <span class="nf">getJoke</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">//设置需要获取的网址</span>
        <span class="k">let</span> <span class="nv">url</span> <span class="o">=</span> <span class="kt">URL</span><span class="p">(</span><span class="nv">string</span><span class="p">:</span> <span class="s">"https://icanhazdadjoke.com/"</span><span class="p">)</span><span class="o">!</span>
        <span class="c1">//请求网址</span>
        <span class="k">var</span> <span class="nv">urlRequest</span> <span class="o">=</span> <span class="kt">URLRequest</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span><span class="n">url</span><span class="p">)</span>
        <span class="c1">//请求获取的类型是application/json（也就是JSON类型）</span>
        <span class="n">urlRequest</span><span class="o">.</span><span class="nf">addValue</span><span class="p">(</span><span class="s">"application/json"</span><span class="p">,</span><span class="nv">forHTTPHeaderField</span><span class="p">:</span> <span class="s">"Accept"</span><span class="p">)</span>
        <span class="c1">//检查获取到的数据</span>
        <span class="kt">URLSession</span><span class="o">.</span><span class="n">shared</span><span class="o">.</span><span class="nf">dataTask</span><span class="p">(</span><span class="nv">with</span><span class="p">:</span> <span class="n">urlRequest</span><span class="p">)</span> <span class="p">{</span> <span class="n">data</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">error</span> <span class="k">in</span>
            <span class="k">do</span> <span class="p">{</span>
                <span class="c1">//将数据赋值给jokeDate，并且判断数据不为空的话</span>
                <span class="k">if</span> <span class="k">let</span> <span class="nv">jokeData</span> <span class="o">=</span> <span class="n">data</span> <span class="p">{</span>
                    <span class="c1">//设置解码器为JSONDecoder()</span>
                    <span class="k">let</span> <span class="nv">decoder</span> <span class="o">=</span> <span class="kt">JSONDecoder</span><span class="p">()</span>
                    <span class="c1">//按照我们之前创建的Joke结构体的数据结构解码获取到的数据（如果我们打算放到数组中，给这里的Joke加个中括号）</span>
                    <span class="k">let</span> <span class="nv">decodedData</span> <span class="o">=</span> <span class="k">try</span> <span class="n">decoder</span><span class="o">.</span><span class="nf">decode</span><span class="p">(</span><span class="kt">Joke</span><span class="o">.</span><span class="k">self</span><span class="p">,</span> <span class="nv">from</span><span class="p">:</span> <span class="n">jokeData</span><span class="p">)</span>
                    <span class="c1">//为了防止数据过多，加载时间过长，这里使用异步加载</span>
                    <span class="kt">DispatchQueue</span><span class="o">.</span><span class="n">main</span><span class="o">.</span><span class="k">async</span> <span class="p">{</span>
                        <span class="c1">//将解码后的数据赋值给之前准备好的空变量</span>
                        <span class="k">self</span><span class="o">.</span><span class="n">jokes</span> <span class="o">=</span> <span class="n">decodedData</span>
                    <span class="p">}</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="c1">//如果数据是空的，在控制台输出下面的文本</span>
                    <span class="nf">print</span><span class="p">(</span><span class="s">"No data"</span><span class="p">)</span>
                <span class="p">}</span>
            <span class="p">}</span> <span class="k">catch</span> <span class="p">{</span>
                <span class="nf">print</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="p">}</span><span class="o">.</span><span class="nf">resume</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">struct</span> <span class="kt">ContentView_Previews</span><span class="p">:</span> <span class="kt">PreviewProvider</span> <span class="p">{</span>
    <span class="kd">static</span> <span class="k">var</span> <span class="nv">previews</span><span class="p">:</span> <span class="kd">some</span> <span class="kt">View</span> <span class="p">{</span>
        <span class="kt">ContentView</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>这里是为了方便演示，所以写在一起了。一般情况下，我们需要新建一个<code class="language-plaintext highlighter-rouge">swift</code>文件来存放struct、请求获取和解码部分的代码。</p>

<p>希望能帮到有需要的人～</p>

        </div>
    </body>
</html>