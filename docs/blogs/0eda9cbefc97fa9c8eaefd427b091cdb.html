<!doctype html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv='content-language' content='en'>
        <title>macOS Assembly Guide</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" type="text/css" href="/assets/css/headerstyle.css" />
        <link rel="stylesheet" type="text/css" href="/assets/css/blogstyle.css" />
        <link rel="stylesheet" type="text/css" href="/assets/css/style.css" />
        <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>macOS Assembly Guide | ZhongUncle’s Blog</title>
<meta name="generator" content="Jekyll v4.3.1" />
<meta property="og:title" content="macOS Assembly Guide" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="This is a guide for assembly language on macOS. ZhongUncle explains why learning assembly language is useful and beneficial." />
<meta property="og:description" content="This is a guide for assembly language on macOS. ZhongUncle explains why learning assembly language is useful and beneficial." />
<link rel="canonical" href="http://localhost:4000/blogs/0eda9cbefc97fa9c8eaefd427b091cdb.html" />
<meta property="og:url" content="http://localhost:4000/blogs/0eda9cbefc97fa9c8eaefd427b091cdb.html" />
<meta property="og:site_name" content="ZhongUncle’s Blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2022-08-13T00:00:00+08:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="macOS Assembly Guide" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-08-13T00:00:00+08:00","datePublished":"2022-08-13T00:00:00+08:00","description":"This is a guide for assembly language on macOS. ZhongUncle explains why learning assembly language is useful and beneficial.","headline":"macOS Assembly Guide","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/blogs/0eda9cbefc97fa9c8eaefd427b091cdb.html"},"url":"http://localhost:4000/blogs/0eda9cbefc97fa9c8eaefd427b091cdb.html"}</script>
<!-- End Jekyll SEO tag -->

        
        <!-- Microsoft Clarity -->
        <script type="text/javascript">
            (function(c,l,a,r,i,t,y){
                c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
                t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
                y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
            })(window, document, "clarity", "script", "ix8xlal10a");
        </script>

        <!-- Google tag (gtag.js) -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=G-SS87H0FDV7"></script>
        <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-SS87H0FDV7');
        </script>

        
    </head>
    <body>
        <div class="stackedit__html">
            <!-- 这个文件里是用来生成导航栏的 -->
<div class="header">
    
        <a href="/index.html" class="headerItem">
            主页
        </a>
    
        <a href="/swift.html" class="headerItem">
            Swift
        </a>
    
        <a href="/unix.html" class="headerItem">
            UNIX
        </a>
    
        <a href="/c.html" class="headerItem">
            C
        </a>
    
        <a href="/assembly.html" class="headerItem">
            Assembly
        </a>
    
        <a href="/go.html" class="headerItem">
            Go
        </a>
    
        <a href="/plan9.html" class="headerItem">
            Plan 9
        </a>
    
        <a href="/web.html" class="headerItem">
            Web
        </a>
    
        <a href="/mcu.html" class="headerItem">
            MCU
        </a>
    
        <a href="/research.html" class="headerItem">
            Research
        </a>
    
        <a href="/non-tech.html" class="headerItem">
            Non-Tech
        </a>
    
</div>
            <h1>macOS Assembly Guide</h1>
            <div class="bloginfo">
                <p class="info">2022-08-13 ｜ <a href="/assembly.html"> Assembly</a> ｜ #Words: 2165 </p>
            </div>
            <p>Since most of the resources, methods and tools for learning assembly are based for Windows. So here I will introduce some materials and tools for macOS</p>

<p>I will continuously update this article and also using it as a personal note.</p>

<h2 id="why-you-need-to-learn-assembly-how-to-use-it">Why you need to learn assembly (How to use it)</h2>
<p>Assembly is the “magic” of computers. You can be a fine “warrior” who only uses high-level languages, but if you “enchant” your “weapon” with assembly, your combat effectiveness will increase greatly (of course, there are also risks of “playing with fire and burning yourself”).</p>

<p>Today, there are several ways to use assembly:</p>

<ul>
  <li>Directly use instructions of computer to write the program and use the assembler to assemble the program (this may be just for education, rarely used in actual situations, it’s too complicated).</li>
  <li>Used in C code to improve performance and speed, or to implement some special functions. For example, the assembly code in UNIX and Linux source codes is to improve the running speed, otherwise it can be written in pure C language; and Apple did not allow developers to obtain the CPU frequency on iOS platform, some developers used assembly code in Objective-C code instructions to infer CPU frequency.</li>
  <li>can understand the decompiled content (this is generally not used by regular programmers).</li>
</ul>

<blockquote>
  <p>Note 1: However, Apple later added a conversion that made the estimation very inaccurate, rendering this kind of app useless.</p>
</blockquote>

<blockquote>
  <p>Note 2: Objective-C is a superset of the C language, just like C++ is also a superset of the C language. They all belong to the C language family. Before Apple use Swift, the development of Apple platforms relied entirely on Objective-C.</p>
</blockquote>

<p>Now, assembly is not the threshold of programming, it’s a required course to become a master. However, novices are still advised to learn C language first before contacting assembly (“learned” means being able to understand various structures and concepts).</p>

<h2 id="references-and-resources">References and Resources</h2>
<p>Today, there are many high-level and script languages, assembly language is becoming more and more unpopular because it is cumbersome, complex and has extremely high learning costs. For example, the Intel CPU development manual has 5,000 pages (and it will be updated every time a new gengeration is released).</p>

<h3 id="mac-os-x-assembler-guide">Mac OS X Assembler Guide</h3>
<p>The first recommendation is Apple’s official assembly guide: “Mac OS X Assembler Guide”, the download address is at <a href="http://personal.denison.edu/~bressoud/cs281-s07/Assembler.pdf">http://personal.denison.edu/~bressoud/cs281-s07/Assembler.pdf</a>.</p>

<p>This guide covers the use of Mac OS X assembler <code class="language-plaintext highlighter-rouge">as</code>, assembly instructions, address modes and more. But it’s not only about Intel CPU, but also about earlier Power PC. Since the latest version of this guide is from 2005, Intel’s instructions have a huge update, such as AVX. And now Apple is already switching to Apple silicon(interestingly, the latest update time of manual of <code class="language-plaintext highlighter-rouge">as</code> is 2020-6-23, which is the day of the M1 released).</p>

<h3 id="introduction-to-x64-assembly">Introduction to x64 Assembly</h3>
<p>The second recommendation is Intel’s <a href="https://www.intel.com/content/dam/develop/external/us/en/documents/introduction-to-x64-assembly-181178 .pdf">“Introduction to x64 Assembly”</a>, this is a short introduction to assembly. It’s friendly for newbies or beginner.</p>

<h3 id="intel-64-and-ia-32-architectures-software-developer-manuals">Intel® 64 and IA-32 Architectures Software Developer Manuals</h3>
<p>The third one is Intel’s development manual: Intel® 64 and IA-32 Architectures Software Developer Manuals.</p>

<p>Although this manual is very long, it is a very good information and is updated frequently. If you need to understand the new Intel instructions, it must be read.</p>

<p>You can directly <a href="https://cdrdv2.intel.com/v1/dl/getContent/671200">Download the bound volume</a> as an archive, but this is inconvenient to read. (Intel used to provide paper copies for free, as long as you sent an email and provided your address. Many people ordered, but most of them used to up monitor or left them in the dust. Now Intel no longer provides this benefit, which is a pity)</p>

<p>The Volume 1 is a general introduction, about the development history and differences of Intel CPU. If you are a beginner, you can take a look. You may be read Volume 2 frequently, it’s about instructions. <strong>The specific differences can be seen in the interface in the <a href="https://www.intel.com/content/www/us/en/developer/articles/technical/intel-sdm.html">Intel® 64 and IA-32 Architectures Software Developer Manuals</a>。</strong></p>

<p>Note that although Intel is often said to updating slowly and liitle, Intel almost every generation will have instructions or registers updates and changes. So the document update frequency is relatively high, if you need to use the latest instructions, then please update your stored documents in time.</p>

<h3 id="arm-assembly-documents">ARM Assembly Documents</h3>
<p>The fourth recommendation is a set of documents about ARM assembly.
Because Mac is now switching to the self-developed M1 chip, which is based on ARM architecture and ARM does not currently provide entire assembly guidelines like Intel. The latest entire guidelines is <a href="https://developer.arm.com/documentation/dui0068/b">《ARM ® DeveloperSuite Assembler Guide Version 1.2》</a> in 2001, if you are a beginner, please read this first.</p>

<p>If you want to learn newest instruction, it’s here: <a href="https://developer.arm.com/architectures/instruction-sets">https://developer.arm.com/architectures/instruction-sets</a></p>

<h2 id="introduction-to-assembler-and-utilities">Introduction to assembler and Utilities</h2>

<blockquote>
  <p>Assembler and compiler are different. If you don’t understand, simply think that the assembler converts assembly instructions into programs; the compiler converts high-level language codes (such as C/C++, Java) into programs.</p>
</blockquote>

<p>Here is an introduction to the assembler and the utilities (including editors) that may be used.</p>

<h3 id="as">as</h3>
<p>The assembler <code class="language-plaintext highlighter-rouge">as</code> for Mac OS X needs to be used in “Terminal”, similar to <code class="language-plaintext highlighter-rouge">masm</code> in Windows. Supports assembly for Intel and Power PC processors. It’s in the <code class="language-plaintext highlighter-rouge">/usr/bin/as</code> directory. There is an introduction to how to use it in the “Mac OS X Assembler Guide”.</p>

<h3 id="ld">ld</h3>
<p><code class="language-plaintext highlighter-rouge">ld</code> is a linker.</p>

<h3 id="clang">clang</h3>
<p>clang can be a assemble and preprocess C or other languages code to assembly code, you can see details in <a href="/blogs/6548d5f3f9473c9af2e20308a7a69b33.html">How to generate assembly code using Clang </a>. Clang maybe make you use assembly easilier.</p>

<h3 id="gcc">gcc</h3>
<p>We don’t talk about the specific differences between <code class="language-plaintext highlighter-rouge">gcc</code> and <code class="language-plaintext highlighter-rouge">clang</code>. <code class="language-plaintext highlighter-rouge">gcc</code> has flag <code class="language-plaintext highlighter-rouge">-nostartfiles</code> ignore the linked standard library files and initialization behavior. Because sometimes you don’t need to connect the C standard library and just assemble it directly. I will make a demonstration at the end.</p>

<h3 id="size">size</h3>
<p><code class="language-plaintext highlighter-rouge">size</code> will output the size of sections, like:</p>

<p><img src="/assets/images/e3de2338d8054a01b7be017cc5fe5880.png" alt="`size` output" /></p>

<h3 id="otool">otool</h3>
<p><code class="language-plaintext highlighter-rouge">otool</code> can check size and content of some section, like <code class="language-plaintext highlighter-rouge">debug.exe</code> on Windows. For example, let’s check content of <code class="language-plaintext highlighter-rouge">__TEXT,__text</code>:</p>

<p><img src="/assets/images/03f673d8ac154d5fa4f67be59e28b960.png" alt="otool check size and content`__TEXT,__text`" /></p>

<p>You also can use <code class="language-plaintext highlighter-rouge">otool</code> to check other sections, format is:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ otool -v -s __TEXT __cstring a.out
a.out:
Contents of (__TEXT,__cstring) section
0000000000000025  hello world!\n
</code></pre></div></div>

<h3 id="xcode">Xcode</h3>
<p>Xcode is Apple development IDE, it not only have GUI application, but also have some CLI utilities. It can write C/C++, Objective-C and Swift code, you also can develop app or programs with some assembly codes.</p>

<p><img src="/assets/images/ecd23a611ef7430eb8c667d0e9676718.png" alt="write assembly code in Xcode" /></p>

<h2 id="syntax-differences">Syntax differences</h2>
<p>Many people may know some assembly, but probably Windows based. But the style and syntax in Mac OS X or C language is different. Because Intel and MASM use Intel syntax, and other use AT&amp;T syntax.</p>

<p>The detail you can see in <a href="/assets/blogs/59a03173ec1a5fae2ec513ef01eba386.html">“「Updating」The syntax style of Apple’s as assembler”</a></p>

<h2 id="lets-write-a-hello-world-in-assembly">Let’s write a Hello World in assembly!</h2>

<h3 id="write-code">Write code</h3>
<p>I will give the complete code at the end, but now I explain it step by step.</p>

<p>At the beginning, create a file <code class="language-plaintext highlighter-rouge">helloworld.s</code>. The suffix of the assembly code file is usually <code class="language-plaintext highlighter-rouge">.asm</code> or <code class="language-plaintext highlighter-rouge">.s</code>. Now you can write the first part.</p>

<p>First, you need to specify <strong>executable command</strong>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>.section	__TEXT,__text,regular,pure_instructions
</code></pre></div></div>

<p>Then specify the target platform and version:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>.build_version macos, 12, 0	sdk_version 12, 1
</code></pre></div></div>

<p>Create a new external symbol name <code class="language-plaintext highlighter-rouge">_main</code> to be the entry of the program, just like a C language program must have a <code class="language-plaintext highlighter-rouge">main()</code> function. Note that the underscore cannot be omitted.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>.globl	_main                           ## -- Begin function main
</code></pre></div></div>

<p>Use the align command to move the position counter to the next boundary <code class="language-plaintext highlighter-rouge">4, 0x90</code> (usually an address).</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>.p2align	4, 0x90
</code></pre></div></div>

<p>Finally, we can start writing the code in <code class="language-plaintext highlighter-rouge">_main</code> part. It also means writing <code class="language-plaintext highlighter-rouge">main()</code> function:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>_main:                                  ## @main
	.cfi_startproc					 ##Indicates the beginning of the function. Will initialize some internal data structures and issue architecture-dependent initial CFI instructions
## %bb.0:
	pushq	%rbp
	.cfi_def_cfa_offset 16
	.cfi_offset %rbp, -16
	movq	%rsp, %rbp
	.cfi_def_cfa_register %rbp
	subq	$16, %rsp
	movl	$0, -4(%rbp)
	leaq	L_.str(%rip), %rdi
	movb	$0, %al
	callq	_printf
	xorl	%eax, %eax
	addq	$16, %rsp
	popq	%rbp
	retq
	.cfi_endproc				##end function
</code></pre></div></div>

<p>There are some cfi instructions. You can find more informations in: <a href="https://web.mit.edu/rhel-doc/3/rhel-as-en-3/cfi-directives.html">https://web.mit.edu/rhel-doc/3/rhel-as-en-3/cfi-directives.html</a></p>

<p>In addition, CFA is the Canonical Frame Address. Related information can be found here: <a href="https://www.keil.com/support/man/docs/armasm/armasm_dom1361290010153.htm">
https://www.keil.com/support/man/docs/armasm/armasm_dom1361290010153.htm</a></p>

<p>Let’s start the second part <strong>The string contained in the executable command</strong>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>.section	__TEXT,__cstring,cstring_literals
L_.str:                                 ## @.str
	.asciz	"hello world!\n"
</code></pre></div></div>

<p>Here is the string to be output: <code class="language-plaintext highlighter-rouge">hello world!\n</code>. If you use the <code class="language-plaintext highlighter-rouge">.ascii</code> command, rather than <code class="language-plaintext highlighter-rouge">.asciz</code>, then this line should be changed to <code class="language-plaintext highlighter-rouge">.ascii "hello world!\n\0"</code>, because <code class="language-plaintext highlighter-rouge">.asciz</code> automatically adds <code class="language-plaintext highlighter-rouge">\0</code> at the end of the string. If write in a C program, use <code class="language-plaintext highlighter-rouge">.asciz</code>.</p>

<p>At the end, you can add this line:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>.subsections_via_symbols
</code></pre></div></div>

<p>This will tell the static link editor how many pieces this part of object file can be divided into. However, it doesn’t matter whether it is used here or not, it does not affect the results. You can add it for rigor.</p>

<p>The full source code is:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	.section	__TEXT,__text,regular,pure_instructions
	.build_version macos, 12, 0	sdk_version 12, 1
	.globl	_main                           ## -- Begin function main
	.p2align	4, 0x90
_main:                                  ## @main
    .cfi_startproc                     ## Indicates the beginning of the function. Will initialize some internal data structures and issue architecture-dependent initial CFI instructions
## %bb.0:
    pushq    %rbp
    .cfi_def_cfa_offset 16
    .cfi_offset %rbp, -16
    movq    %rsp, %rbp
    .cfi_def_cfa_register %rbp
    subq    $16, %rsp
    movl    $0, -4(%rbp)
    leaq    L_.str(%rip), %rdi
    movb    $0, %al
    callq    _printf
    xorl    %eax, %eax
    addq    $16, %rsp
    popq    %rbp
    retq
    .cfi_endproc                ## end function
	.section	__TEXT,__cstring,cstring_literals
L_.str:                                 ## @.str
	.asciz	"hello world!\n"

.subsections_via_symbols
</code></pre></div></div>

<h3 id="assemble-to-a-executable-file">Assemble to a executable file</h3>
<p>In Windows, the mainstream executable file format is PE (Portable Executable File Format), and the abbreviation of “Executable” is the EXE that many people are familiar with. In macOS, executable files are called “Mach-O executable files”.</p>

<p>If you use <code class="language-plaintext highlighter-rouge">file</code> to check a Mach-O executable file, you can see someting like below. Here let’s check Xcode:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ file /Applications/Xcode.app/Contents/MacOS/Xcode 
Xcode: Mach-O universal binary with 2 architectures: [x86_64:Mach-O 64-bit executable x86_64] [arm64:Mach-O 64-bit executable arm64]
Xcode (for architecture x86_64):	Mach-O 64-bit executable x86_64
Xcode (for architecture arm64):	Mach-O 64-bit executable arm64
</code></pre></div></div>

<p>So the finally you need to convert <code class="language-plaintext highlighter-rouge">hello.s</code> to a Mach-O executable file.</p>

<p>There are two methods:</p>
<h4 id="method-1">Method 1</h4>
<p>Since this program is very simple and does not link to any special libraries, you can directly use the following command:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ gcc -nostartfiles helloworld.s
$ chmod 755 a.out
$ file a.out 
a.out: Mach-O 64-bit executable x86_64
</code></pre></div></div>

<p>Now you can see <code class="language-plaintext highlighter-rouge">a.out</code> is our <code class="language-plaintext highlighter-rouge">Mach-O executable file</code> needed。</p>

<p>Run it:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ ./a.out 
hello world!
</code></pre></div></div>

<p>Very nice.</p>

<h4 id="method-2">Method 2</h4>
<p>This is common method. First use <code class="language-plaintext highlighter-rouge">as</code> to assemble the code and modify the permissions:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ as hello.s
$ chmod 755 a.out 
</code></pre></div></div>

<p><strong>You need to notice <code class="language-plaintext highlighter-rouge">as</code> will generate Mach-O object file, rather than <code class="language-plaintext highlighter-rouge">Mach-O executable file</code>. <code class="language-plaintext highlighter-rouge">Mach-O executable file</code> can not run, it will warning <code class="language-plaintext highlighter-rouge">cannot execute binary file</code>. On Windows, object file is named as COFF (Common Object File Format).</strong></p>

<p>Then use the linker <code class="language-plaintext highlighter-rouge">ld</code> to deal with object files. But if directly and simply use the <code class="language-plaintext highlighter-rouge">ld</code>, you will see:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ ld a.out
Undefined symbols for architecture x86_64:
  "_printf", referenced from:
      _main in a.out
ld: symbol(s) not found for architecture x86_64
</code></pre></div></div>

<p>Because it uses <code class="language-plaintext highlighter-rouge">_printf</code> in C standard library, but <code class="language-plaintext highlighter-rouge">ld</code> can’t find it directly. So, add library path is fine:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ ld a.out -o hello -lSystem -L/Library/Developer/CommandLineTools/SDKs/MacOSX.sdk/usr/lib
</code></pre></div></div>

<p><strong>Common <code class="language-plaintext highlighter-rouge">Mach-O executable file</code> doesn’t have any suffiex</strong>. The <code class="language-plaintext highlighter-rouge">hello</code> is <code class="language-plaintext highlighter-rouge">Mach-O executable file</code> we need. You can use <code class="language-plaintext highlighter-rouge">file</code> to check it:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ file hello
hello: Mach-O 64-bit executable x86_64
</code></pre></div></div>

<p>Run it:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ ./hello
hello world!
</code></pre></div></div>

<p>Very Nice~</p>

<p>I hope these will help someone in need~</p>

        </div>
        <!-- comment by utterances -->
        <script src="https://utteranc.es/client.js"
        repo="ZhongUncle/zhonguncle.github.io"
        issue-term="url"
        theme="github-light"
        crossorigin="anonymous"
        async>
        </script>
        <!-- <div class="footer__html">
            <p>
                You can find me in: 
                <a href="https://blog.csdn.net/qq_33919450">CSDN</a>
                <a href="https://github.com/ZhongUncle">GitHub</a>
            </p>
        </div> -->
    </body>
</html>