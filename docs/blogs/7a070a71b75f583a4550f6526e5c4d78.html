<!doctype html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv='content-language' content='zh-CN'>
        <title>「Swift」如何测量一个函数/功能的运行时间</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" type="text/css" href="/assets/css/headerstyle.css" />
        <link rel="stylesheet" type="text/css" href="/assets/css/blogstyle.css" />
        <link rel="stylesheet" type="text/css" href="/assets/css/style.css" />
        <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>「Swift」如何测量一个函数/功能的运行时间</title>
<meta name="generator" content="Jekyll v4.3.1" />
<meta property="og:title" content="「Swift」如何测量一个函数/功能的运行时间" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="当需要测试程序的性能时，Xcode 自带的测试功能有时并不能满足我们的需要，这个时候就需要自己编写测试代码。测试性能主要是测试程序或代码运行时间，不论是测试 CPU/GPU 密集型程序，还是读写密集型程序，都需要获取程序或函数的运行时间来计算性能。" />
<meta property="og:description" content="当需要测试程序的性能时，Xcode 自带的测试功能有时并不能满足我们的需要，这个时候就需要自己编写测试代码。测试性能主要是测试程序或代码运行时间，不论是测试 CPU/GPU 密集型程序，还是读写密集型程序，都需要获取程序或函数的运行时间来计算性能。" />
<link rel="canonical" href="http://localhost:4000/blogs/7a070a71b75f583a4550f6526e5c4d78.html" />
<meta property="og:url" content="http://localhost:4000/blogs/7a070a71b75f583a4550f6526e5c4d78.html" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2023-04-02T00:00:00+08:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="「Swift」如何测量一个函数/功能的运行时间" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2023-04-02T00:00:00+08:00","datePublished":"2023-04-02T00:00:00+08:00","description":"当需要测试程序的性能时，Xcode 自带的测试功能有时并不能满足我们的需要，这个时候就需要自己编写测试代码。测试性能主要是测试程序或代码运行时间，不论是测试 CPU/GPU 密集型程序，还是读写密集型程序，都需要获取程序或函数的运行时间来计算性能。","headline":"「Swift」如何测量一个函数/功能的运行时间","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/blogs/7a070a71b75f583a4550f6526e5c4d78.html"},"url":"http://localhost:4000/blogs/7a070a71b75f583a4550f6526e5c4d78.html"}</script>
<!-- End Jekyll SEO tag -->

    </head>
    <body>
        <div class="stackedit__html">
            <!-- 这个文件里是用来生成导航栏的 -->
<div class="header">
    
        <a href="/index.html" class="headerItem">
            主页
        </a>
    
        <a href="/swiftui.html" class="headerItem">
            SwiftUI
        </a>
    
        <a href="/unix.html" class="headerItem">
            UNIX
        </a>
    
        <a href="/c.html" class="headerItem">
            C
        </a>
    
        <a href="/assembly.html" class="headerItem">
            Assembly
        </a>
    
        <a href="/plan9.html" class="headerItem">
            Plan 9
        </a>
    
        <a href="/web.html" class="headerItem">
            Web
        </a>
    
        <a href="/research.html" class="headerItem">
            Research
        </a>
    
        <a href="/non-tech.html" class="headerItem">
            Non-Tech
        </a>
    
</div>
            <h1>「Swift」如何测量一个函数/功能的运行时间</h1>
            <div class="bloginfo">
                <p class="info">2023-04-02 ｜ <a href="/swiftui.html"> SwiftUI</a> ｜ 1409 字</p>
            </div>
            <!-- excerpt-start -->
<p>当需要测试程序的性能时，Xcode 自带的测试功能有时并不能满足我们的需要，这个时候就需要自己编写测试代码。测试性能主要是测试程序或代码运行时间，不论是测试 CPU/GPU 密集型程序，还是读写密集型程序，都需要获取程序或函数的运行时间来计算性能。</p>

<p>如果是测试 CLI（Command Line Interface，命令行交互）程序，那么就可以在使用程序时，加上<code class="language-plaintext highlighter-rouge">time</code>命令，就可以获取整个程序的运行时间。但是如果想测试程序代码中的某一个函数运行时间，或者测试 GUI 程序的时候，这种方法就行不通了。我们需要在代码中加上一个“计时器”，去自己安排测量工作。</p>

<p>在 Swift 中实现这种测量有两种方法，第一个是比较方便但是只能在新系统上用，第二个兼容性比较好但是不安全（精确度稍差，但是可以忽略）。</p>

<h2 id="新系统上的简易方法measure">新系统上的简易方法<code class="language-plaintext highlighter-rouge">measure</code></h2>
<p>不过苹果在 iOS 16、macOS 13 开始，新增了的数据结构<code class="language-plaintext highlighter-rouge">Clock</code>和<code class="language-plaintext highlighter-rouge">ContinuousClock</code>，都有一个方法叫<code class="language-plaintext highlighter-rouge">measure</code>，可以用来测试一个函数的运行时间。</p>

<p><img src="/assets/images/de8eb23ff5d84f33aefbf193715d64b0.png" alt="measure官方文档" /></p>

<p>使用起来也非常简单。</p>

<p>首先，实例一个<code class="language-plaintext highlighter-rouge">ContinuousClock</code>：</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">let</span> <span class="nv">clock</span> <span class="o">=</span> <span class="kt">ContinuousClock</span><span class="p">()</span>
</code></pre></div></div>

<p>然后再使用以下语句即可获取某个函数的运行时间：</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">let</span> <span class="nv">elapsed</span> <span class="o">=</span> <span class="n">clock</span><span class="o">.</span><span class="n">measure</span> <span class="p">{</span>
	<span class="nf">someWork</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></div></div>

<p>这里需要注意，<code class="language-plaintext highlighter-rouge">let</code>是强制使用的，不能前面声明一个变量，然后在这实例化。</p>

<p>这里获得的<code class="language-plaintext highlighter-rouge">elapsed</code>是<code class="language-plaintext highlighter-rouge">ContinuousClock.Instant.Duration</code>类型的，需要转化成字符串使用，转化方法如下：</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">var</span> <span class="nv">duration</span><span class="p">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="s">""</span>
<span class="k">let</span> <span class="nv">elapsed</span> <span class="o">=</span> <span class="n">clock</span><span class="o">.</span><span class="n">measure</span> <span class="p">{</span>
	<span class="nf">quicksort</span><span class="p">()</span>
<span class="p">}</span>
<span class="c1">//elapsed.description是字符串类型</span>
<span class="n">duration</span> <span class="o">=</span> <span class="n">elapsed</span><span class="o">.</span><span class="n">description</span>
</code></pre></div></div>

<p>总体代码为：</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">struct</span> <span class="kt">ContentView</span><span class="p">:</span> <span class="kt">View</span> <span class="p">{</span>
    <span class="k">var</span> <span class="nv">clock</span> <span class="o">=</span> <span class="kt">ContinuousClock</span><span class="p">()</span>
    <span class="kd">@State</span> <span class="kd">private</span> <span class="k">var</span> <span class="nv">duration</span><span class="p">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="s">""</span>
    <span class="k">var</span> <span class="nv">body</span><span class="p">:</span> <span class="kd">some</span> <span class="kt">View</span> <span class="p">{</span>
        <span class="kt">VStack</span> <span class="p">{</span>
            <span class="kt">Text</span><span class="p">(</span><span class="s">"点击按钮进行快速排序测试："</span><span class="p">)</span>
                <span class="o">.</span><span class="nf">padding</span><span class="p">()</span>
                
            <span class="kt">Button</span><span class="p">(</span><span class="nv">action</span><span class="p">:</span> <span class="p">{</span>
            	<span class="c1">//获取时间间隔，也就是运行时间</span>
                <span class="k">let</span> <span class="nv">elapsed</span> <span class="o">=</span> <span class="n">clock</span><span class="o">.</span><span class="n">measure</span> <span class="p">{</span>
                	<span class="c1">//测试函数为‘quicksort’</span>
                	<span class="nf">quicksort</span><span class="p">()</span>
                <span class="p">}</span>
                <span class="c1">//把获取到的时间间隔转换成字符串</span>
                <span class="n">duration</span> <span class="o">=</span> <span class="n">elapsed</span><span class="o">.</span><span class="n">description</span>
            <span class="p">})</span> <span class="p">{</span>
                <span class="kt">Text</span><span class="p">(</span><span class="s">"Start"</span><span class="p">)</span>
            <span class="p">}</span>
            <span class="o">.</span><span class="nf">padding</span><span class="p">()</span>

			<span class="c1">// 显示时间，由于elapsed.description最后自带字符串“second”，所以不用加单位</span>
            <span class="kt">Text</span><span class="p">(</span><span class="s">"消耗时间为：</span><span class="se">\(</span><span class="n">duration</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
                <span class="o">.</span><span class="nf">padding</span><span class="p">()</span>
        <span class="p">}</span>
        <span class="o">.</span><span class="nf">padding</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>下面是在 App 中运行的情况：</p>

<p><img alt="在 App 中运行的情况" src="/assets/images/6462775863e24368b0291eb2b84e73ac.gif" width="350" /></p>

<h2 id="通用方法">通用方法</h2>
<p>如果不是最新的系统，或者是想自己写相关的方法函数，那么就可以使用经典办法：时间差。记录开始的时间和终止的时间，再做差即可获得运行时间。</p>

<p>那么这个时间以什么为准呢？C 语言是时钟时间，但是 Swift 从 iOS 16 开始才有时钟时间，之前只有<code class="language-plaintext highlighter-rouge">Date</code>类型。好在 Date 就可以实现我们的目的，使用其中的<code class="language-plaintext highlighter-rouge">timeIntervalSince1970</code>值即可。</p>

<p><code class="language-plaintext highlighter-rouge">timeIntervalSince1970</code>这个值是非常有历史含义的一个值，所有的系统（不光是苹果的系统）都有这个值，因为 1970 是第一个大范围使用的系统 Unix 的起始时间，而<code class="language-plaintext highlighter-rouge">timeIntervalSince1970</code>记录的是从 1970-01-01 00:00:00 开始，到此时此刻过去的时间，精度可以到达小数点到达毫秒（甚至更小，与上一种方法精度差不多）。</p>

<p>由于和上一个方法只有一部分不同，所以直接列出整体代码：</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">struct</span> <span class="kt">ContentView</span><span class="p">:</span> <span class="kt">View</span> <span class="p">{</span>
    <span class="kd">@State</span> <span class="kd">private</span> <span class="k">var</span> <span class="nv">duration</span><span class="p">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="s">""</span>
    <span class="k">var</span> <span class="nv">body</span><span class="p">:</span> <span class="kd">some</span> <span class="kt">View</span> <span class="p">{</span>
        <span class="kt">VStack</span> <span class="p">{</span>
            <span class="kt">Text</span><span class="p">(</span><span class="s">"点击按钮进行快速排序测试："</span><span class="p">)</span>
                <span class="o">.</span><span class="nf">padding</span><span class="p">()</span>
            <span class="kt">Button</span><span class="p">(</span><span class="nv">action</span><span class="p">:</span> <span class="p">{</span>
            	<span class="c1">//记录开始时间</span>
                <span class="k">let</span> <span class="nv">start_time</span> <span class="o">=</span> <span class="kt">Date</span><span class="p">()</span><span class="o">.</span><span class="n">timeIntervalSince1970</span>
                <span class="c1">//开始运行被测试函数</span>
                <span class="nf">quicksort</span><span class="p">()</span>
                <span class="c1">//记录结束时间</span>
                <span class="k">let</span> <span class="nv">end_time</span> <span class="o">=</span> <span class="kt">Date</span><span class="p">()</span><span class="o">.</span><span class="n">timeIntervalSince1970</span>
                <span class="c1">//做差获取间隔时间，并且将其变成字符串格式</span>
                <span class="n">duration</span> <span class="o">=</span> <span class="kt">TimeInterval</span><span class="p">(</span><span class="n">end_time</span><span class="o">-</span><span class="n">start_time</span><span class="p">)</span><span class="o">.</span><span class="n">description</span>
            <span class="p">})</span> <span class="p">{</span>
                <span class="kt">Text</span><span class="p">(</span><span class="s">"Start"</span><span class="p">)</span>
            <span class="p">}</span>
            <span class="o">.</span><span class="nf">padding</span><span class="p">()</span>

			<span class="c1">//由于这个方法没有带单位，所以自己加一个“seconds”</span>
            <span class="kt">Text</span><span class="p">(</span><span class="s">"消耗时间为：</span><span class="se">\(</span><span class="n">duration</span><span class="se">)</span><span class="s"> seconds"</span><span class="p">)</span>
                <span class="o">.</span><span class="nf">padding</span><span class="p">()</span>
        <span class="p">}</span>
        <span class="o">.</span><span class="nf">padding</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>运行效果和上一种方法一模一样，所以不列出了。</p>

<p>希望能帮到有需要的人～</p>

        </div>
    </body>
</html>